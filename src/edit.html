<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" href="data:;base64,=" />
		<title>Edit</title>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"
			integrity="sha512-8RnEqURPUc5aqFEN04aQEiPlSAdE0jlFS/9iGgUyNtwFnSKCXhmB6ZTNl7LnDtDWKabJIASzXrzD0K+LYexU9g=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css"
			integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		/>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css"
			integrity="sha512-R6PH4vSzF2Yxjdvb2p2FA06yWul+U0PDDav4b/od/oXf9Iw37zl10plvwOXelrjV2Ai7Eo3vyHeyFUjhXdBCVQ=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		/>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"
			integrity="sha512-LarNmzVokUmcA7aUDtqZ6oTS+YXmUKzpGdm8DxC46A6AHu+PQiYCUlwEGWidjVYMo/QXZMFMIadZtrkfApYp/g=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"
			integrity="sha512-I6CdJdruzGtvDyvdO4YsiAq+pkWf2efgd1ZUSK2FnM/u2VuRASPC7GowWQrWyjxCZn6CT89s3ddGI+be0Ak9Fg=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"
			integrity="sha512-rQImvJlBa8MV1Tl1SXR5zD2bWfmgCEIzTieFegGg89AAt7j/NBEe50M5CqYQJnRwtkjKMmuYgHBqtD1Ubbk5ww=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"
			integrity="sha512-HN6cn6mIWeFJFwRN9yetDAMSh+AK9myHF1X9GlSlKmThaat65342Yw8wL7ITuaJnPioG0SYG09gy0qd5+s777w=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
	</head>
	<body>
		<noscript>
			<p>Please enable JavaScript to use this page.</p>
		</noscript>
		<template id="header-row-teml">
			<div class="header-row">
				<div class="edit-group">
					<label for="header-name">Header Name</label>
					<input type="text" name="header-name" list="common-headers" />
				</div>
				<div class="edit-group">
					<label for="header-value">Header Value</label>
					<input type="text" name="header-value" list="common-headers-values" />
				</div>
				<div class="edit-group">
					<button type="button" class="remove-header">Remove</button>
				</div>
			</div>
		</template>
		<main class="container">
			<a id="back-to-file-list">&lt; Go back to file list</a>
			<h1 id="title"></h1>
			<form id="edit-form">
				<div class="status-group">
					<span>
						<label for="status">Status</label>
						<input name="status" pattern="[0-9]+" value="200" list="common-status" />
					</span>
					<span>
						<label for="status-text">Status Text</label>
						<input type="text" name="status-text" value="OK" list="common-status-text" />
					</span>
				</div>
				<div class="headers"></div>
				<button type="button" class="add-header">Add Header</button>
				<div class="editor-container">
					<textarea class="editor"></textarea>
				</div>
				<button type="submit">Save</button>
				<button class="delete">Delete</button>

				<datalist id="common-status">
					<option value="200"></option>
					<option value="201"></option>
					<option value="202"></option>
					<option value="204"></option>
					<option value="301"></option>
					<option value="302"></option>
					<option value="400"></option>
					<option value="401"></option>
					<option value="403"></option>
					<option value="404"></option>
					<option value="418"></option>
					<option value="500"></option>
				</datalist>
				<datalist id="common-status-text">
					<option value="OK"></option>
					<option value="Created"></option>
					<option value="Accepted"></option>
					<option value="No Content"></option>
					<option value="Moved Permanently"></option>
					<option value="Found"></option>
					<option value="Bad Request"></option>
					<option value="Unauthorized"></option>
					<option value="Forbidden"></option>
					<option value="Not Found"></option>
					<option value="I'm a teapot"></option>
					<option value="Internal Server Error"></option>
				</datalist>
				<datalist id="common-headers">
					<option value="Content-Type"></option>
					<option value="Content-Security-Policy"></option>
					<option value="Location"></option>
					<option value="Access-Control-Allow-Origin"></option>
				</datalist>
				<datalist id="common-headers-values">
					<option value="text/html"></option>
					<option value="text/javascript"></option>
					<option value="text/css"></option>
					<option value="application/json"></option>
					<option value="text/plain"></option>
					<option value="*"></option>
				</datalist>
			</form>
		</main>
		<script>
			function setTitle(mode, filepath) {
				document.title = `${mode} ${filepath}`;
				document.getElementById('title').textContent = mode + ' ';
				const a = document.createElement('a');
				a.href = filepath;
				a.textContent = filepath;
				document.getElementById('title').appendChild(a);
			}

			// Get the file path from the URL
			const url = new URL(location.href);
			const filepath = '/' + url.pathname.split('/').slice(2).join('/');
			setTitle('Editing', filepath);

			const prefix = url.pathname.split('/').slice(0, 2).join('/');
			document.getElementById('back-to-file-list').href = prefix;

			// Initialize the form
			const editForm = document.getElementById('edit-form');
			const headers = editForm.querySelector('.headers');
			const headerRowTeml = document.getElementById('header-row-teml');
			const addHeaderBtn = editForm.querySelector('.add-header');
			addHeaderBtn.addEventListener('click', () => {
				const headerRow = headerRowTeml.content.cloneNode(true);
				headers.appendChild(headerRow);
			});
			headers.addEventListener('click', (event) => {
				if (event.target.classList.contains('remove-header')) {
					event.target.closest('.header-row').remove();
				}
			});
			editForm.addEventListener('submit', (event) => {
				event.preventDefault();
				const headers = {};
				for (const headerRow of editForm.querySelectorAll('.header-row')) {
					const name = headerRow.querySelector('[name="header-name"]').value;
					const value = headerRow.querySelector('[name="header-value"]').value;
					if (name && value) {
						headers[name] = value;
					}
				}
				fetch(location.href, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						content: editor.getValue(),
						headers,
						status: parseInt(editForm.querySelector('[name="status"]').value),
						statusText: editForm.querySelector('[name="status-text"]').value,
					}),
				}).then((r) => {
					if (r.ok) {
						location.reload();
					} else {
						alert('Error');
					}
				});
			});
			editForm.querySelector('.delete').addEventListener('click', (event) => {
				event.preventDefault();
				if (confirm(`Are you sure you want to delete ${filepath}?`)) {
					fetch(location.href, {
						method: 'DELETE',
					}).then((r) => {
						if (r.ok) {
							alert('Deleted');
							location.reload();
						} else {
							alert('Error');
						}
					});
				}
			});

			// Initialize the editor
			const editor = CodeMirror.fromTextArea(editForm.querySelector('.editor'), {
				lineNumbers: true,
				indentUnit: 4,
				mode: 'htmlmixed',
				theme: 'monokai',
			});
			fetch(location.href, {
				headers: {
					Accept: 'application/json',
				},
			})
				.then((r) => {
					return r.json();
				})
				.then((res) => {
					console.log(res);
					if (!res) {
						setTitle('Creating', filepath);
						return;
					}
					document.querySelector('[name="status"]').value = res.status;
					document.querySelector('[name="status-text"]').value = res.statusText;
					editor.setValue(res.content);
					for (const [name, value] of Object.entries(res.headers)) {
						const headerRow = headerRowTeml.content.cloneNode(true);
						headerRow.querySelector('[name="header-name"]').value = name;
						headerRow.querySelector('[name="header-value"]').value = value;
						headers.appendChild(headerRow);
					}

					const contentType = Object.entries(res.headers).find(([name]) => {
						return name.toLowerCase() === 'content-type';
					})?.[1];
					if (contentType) {
						const modeMap = {
							'text/html': 'htmlmixed',
							'text/javascript': 'javascript',
							'text/css': 'css',
							'application/json': 'javascript',
							'text/plain': 'text',
						};
						const mode = contentType.split(';')[0];
						editor.setOption('mode', modeMap[mode] || 'text');
					}
				});
		</script>
		<style>
			.container {
				max-width: 800px;
				margin: 0 auto;
			}
			.editor-container {
				margin-top: 1rem;
				margin-bottom: 1rem;
			}
			.status-group {
				display: flex;
				margin-bottom: 0.5rem;
			}
			.header-row {
				display: flex;
				margin-bottom: 0.5rem;
			}
			.header-row .edit-group {
				margin-right: 0.5rem;
			}
			.header-row .edit-group:last-of-type {
				margin-left: auto;
				margin-right: 0;
			}
			@media (prefers-color-scheme: dark) {
				body {
					background-color: #222;
					color: #fff;
				}
			}
		</style>
	</body>
</html>
